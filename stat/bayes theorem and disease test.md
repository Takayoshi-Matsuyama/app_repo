# ベイズの定理と疾患検査

# 要旨

本稿は、個人的に勉強した内容を技術論文としてまとめたものである。

本稿を書くために使用したpythonコードをフリーウェアとして公開する。

本稿には、以下について記す。

* 理論の確認（条件付き確率、ベイズの定理）
* 応用例として疾患の検査を想定し、陽性の場合に、真に疾患があるかどうかを統計的に調べる。

## ベイズの定理

* ある事象（結果）と、その要因となっている複数の事象（原因）を考える<br>
例1：故障（結果）と、部品の不良（原因）<br>
例2：陽性（結果）と、疾患の有無（原因）
* 原因ごとに結果が発生する確率が予め調査済みであるとする。<br>
ベイズの定理を使うと、その結果となったとき、それぞれの原因が実際に結果を引き起こした確率を計算できる

## ベイズの定理の意義

* 故障や不具合が発生したときに、調査・対策に優先順位を付け、早期に解決を図ることができる<br>
* 予め原因と故障の関係を整理することは、設計・開発段階での問題発見を促す。その結果、故障や不具合自体を低減できる。<br>故障の原因や影響の解析方法として、以下が知られている。
    * FTA (Fault Tree Analysis / 故障の木解析) (システム故障 → 部品故障へ分解)
    * FMEA (Failure Mode and Effects / 故障モード影響解析) (部品故障 → システム故障への影響解析)
    * DRBFM (Design Review Based on Failure Mode) (変更点・変化点に着目した故障モードの影響解析)
* ベイズの定理を使うと、可能性を理論的・定量的に検討できる。それは、直感や印象に惑わされることなく、適切な対応をとるために役立つものである。

# 理論の確認

## 条件付き確率
事象 $A$ が起こるという条件の下で事象 $B$ が起こる確率は、それぞれの事象の要素数 $N_A$ 、$N_{A \cap B}$ の比。その分子分母を全事象 $\Omega$ の数で割る。

$$
P(B|A) = \dfrac{N_{A \cap B}}{N_A} = \dfrac{\dfrac{N_{A \cap B}}{N_\Omega}}{\dfrac{N_A}{N_\Omega}} = \frac{P(A \cap B)}{P(A)}
$$

![A_and_B](./bayes%20theorem%20and%20disease%20test%20data/A%20and%20B.png)

### 例

サイコロの目が偶数である $(A = \{2, 4, 6 \})$ という条件の下で    
その目が2である $(B = \{ 2 \})$  
この確率は

$$
P(B|A) = \frac{P(A \cap B)}{P(A)} = \dfrac{\frac{1}{6}}{\frac{3}{6}} = \frac{1}{3}
$$

## 乗法定理

条件付き確率の式の両辺に $P(A)$ を掛ける。

$$
P(A \cap B) = P(A) P(B|A)
$$

### 例

10本のくじあり、当たり3本  
太郎さんが当たり $(A)$ という条件の下で  
花子さんも当たり $(B|A)$ という事象が  
同時に起こる $(A \cap B)$  
この確率は

$$
P(A \cap B) = P(A) P(B|A) = \frac{3}{10} \times \frac{2}{9} = \frac{1}{15}
$$

## ベイズの定理

事象 $A$ がある。  
事象 $A$ の原因として、排反な $n$ 個の事象 $H_1, H_2, \dots, H_n$ がある。

![A_and_Hn](./bayes%20theorem%20and%20disease%20test%20data/A%20and%20Hn.png)

事象 $A$ が起こったという条件の下で  
その原因が $H_i$ であったとする。  
この条件付き確率は
$$
\begin{aligned}
P(H_i|A) &= \frac{P(H_i \cap A)}{P(A)} \\
         &= \frac{P(H_i) P(A|H_i)}{P(A)} \quad (乗法定理) \\
         &= \frac{P(H_i) P(A|H_i)}{P(A \cap H_1) + P(A \cap H_2) + \cdots + P(A \cap H_n)} \quad (和事象の確率) \\
         &= \frac{P(H_i) P(A|H_i)}{P(H_1)P(A|H_1) + P(H_2)P(A|H_2) + \cdots + P(H_n)P(A|H_n)} \quad (乗法定理) \\
         &= \frac{P(H_i) P(A|H_i)}{\displaystyle \sum_{j=1}^n P(H_j)P(A|H_j)}
\end{aligned}
$$

まとめる。ベイズの定理：
$$
P(H_i|A) = \frac{P(H_i) P(A|H_i)}{\displaystyle \sum_{j=1}^n P(H_j)P(A|H_j)}
$$

$P(H_i)$ は **事前確率 (prior probability)** と呼ばれる。 (事象 $H_i$ は $A$ に先立つものと考える)  
$P(H_i|A)$ は **事後確率 (posterior probability)** と呼ばれる。 (事象 $A$ が起こったという条件の下で、 $H_i$が発生)


$P(A|H_i)$ (原因ごとに事象 $A$ が起こる条件付き確率)が推定可能な場合、  
事象 $A$ が起こったとき、それぞれの原因が実際に結果を引き起こした確率 (事後確率 $P(H_i|A)$ ) を計算できる。

# 応用 (疾患検査)

ベイズの定理の応用として、疾患検査で陽性と判定された場合に、真に疾患がある可能性を考える。

## 想定状況

* 全人口において、0.1%の者に疾患がある。
* 無作為抽出した対象者に検査を行う。
* 検査精度として、2つの指標がある。
    * 感度（「疾患あり」のうち、正しく陽性と判定する割合） 70%
    * 特異度 (「疾患なし」)のうち、正しく陰性と判定する割合） 99%


![test_situation](./bayes%20theorem%20and%20disease%20test%20data/test_situation.png)

## 1回目の検査

### 事前確率

| 項目 | 式 | 値 | 備考 |
| --- | --- | --- | --- |
| 疾患率 | $P(H_1)$ | 0.001 (0.1%) | 全人口における疾患率<br>=検査対象者(無作為抽出)における疾患率|
| 疾患なし率 | $P(H_2) = 1 - P(H_1)$ | 0.999 (99.9%) | |

### 検査精度

| 項目 | 式 | 値 | 備考 |
| --- | --- | --- |--- |
| (1) 真陽性率(感度) | $P(A\|H_1)$ | 0.7 (70%) | 「疾患あり」を、陽性と判定する割合 |
| (2) 偽陽性率 | $P(A\|H_2) = 1-P(A^{c}\|H_2)$ | 0.01 (1%) | 「疾患なし」を、陽性と誤認する割合|
| (3) 真陰性率(特異度) | $P(A^{c}\|H_2)$ | 0.99 (99%) | 「疾患なし」を、陰性と判定する割合
| (4) 偽陰性率 | $P(A^{c}\|H_1) = 1 - P(A\|H_1)$ | 0.3 (30%) | 「疾患あり」を、陰性と誤認する割合 |

### 事後確率

| 項目 | 式 | 計算 (ベイズの定理より) | 値 |
| --- | --- | --- | --- | 
| (1) 陽性で疾患あり(真陽性) | $P(H_1\|A)$ | $\dfrac{P(A \cap H_1)}{P(A \cap H_1) + P(A \cap H_2)} = \dfrac{P(H_1)P(A\|H_1)}{P(H_1)P(A\|H_1) + P(H_2)P(A\|H_2)} = \dfrac{0.001 \times 0.7}{0.001 \times 0.7 + 0.999 \times 0.01}$ | 0.065 (6.5%) |
| (2) 陽性だが疾患なし(偽陽性) | $P(H_2\|A)$ | $\dfrac{P(A \cap H_2)}{P(A \cap H_1) + P(A \cap H_2)} = \dfrac{P(H_2)P(A\|H_2)}{P(H_1)P(A\|H_1) + P(H_2)P(A\|H_2)} = \dfrac{0.999 \times 0.01}{0.001 \times 0.7 + 0.999 \times 0.01}$ | 0.935 (93.5%) |
| (3) 陰性で疾患なし(真陰性) | $ P(H_2\|A^{c})$ | $\dfrac{P(A^{c} \cap H_2)}{P(A^{c} \cap H_1) + P(A^{c} \cap H_2)} = \dfrac{P(H_2)P(A^{c}\|H_2)}{P(H_1)P(A^{c}\|H_1) + P(H_2)P(A^{c}\|H_2)} = \dfrac{0.999 \times 0.99}{0.001 \times 0.3 + 0.999 \times 0.99} $ | 0.9997 (99.97%) |
| (4) 陰性だが疾患あり(偽陰性) | $P(H_1\|A^{c})$ | $\dfrac{P(A^{c} \cap H_1)}{P(A^{c} \cap H_1) + P(A^{c} \cap H_2)} = \dfrac{P(H_1)P(A^{c}\|H_1)}{P(H_1)P(A^{c}\|H_1) + P(H_2)P(A^{c}\|H_2)}= \dfrac{0.001 \times 0.3}{0.001 \times 0.3 + 0.999 \times 0.99} $ | 0.0003 (0.03%) |

### 考察

陰性の場合

* 真陰性率 = 99.97% であり、疾患なしの可能性が高い。

陽性の場合

* 検査結果が陽性であっても、直感に反して、真に疾患がある可能性は100%でなく、むしろ低い（真陽性率=6.5%）
* これは検査が完全ではなく（偽陽性率 ≠ 0、偽陰性率 ≠ 0）、また、検査対象に非疾患者が多く含まれるため（事前疾患率 $P(H_1)$ =0.1%）である
* 一方、検査を経たことで、感染の疑いは強まっている（検査前の65倍。事前確率 全人口の疾患率 0.1% → 検査事後の真陽性率 6.5%）
* この状況で再検査を受け、陽性と判定された場合、真に疾患がある確率はどのくらいになるだろうか？

## 2回目の検査（1回目検査結果：陽性）

### 事前確率（2回目）

前回検査の真陽性率（事後）を、事前確率に設定する。

| 項目 | 式 | 値 | 備考 |
| --- | --- | --- | --- |
| 疾患率 | $P(H_1)$ | 0.065 (6.5%) | 1回目検査の真陽性率（事後）|
| 疾患なし率 | $P(H_2) = 1 - P(H_1)$ | 0.935 (93.5%) | |

### 検査精度（2回目）

検査精度は、前回検査と同じ。  
変化したのは、被検査者の状況である。

### 事後確率（2回目）

| 項目 | 式 | 計算 (ベイズの定理より) | 値 |
| --- | --- | --- | --- | 
| (1) 陽性で疾患あり(真陽性) | $P(H_1\|A)$ | $\dfrac{P(A \cap H_1)}{P(A \cap H_1) + P(A \cap H_2)} = \dfrac{P(H_1)P(A\|H_1)}{P(H_1)P(A\|H_1) + P(H_2)P(A\|H_2)} = \dfrac{0.065 \times 0.7}{0.065 \times 0.7 + 0.935 \times 0.01}$ | 0.830 (83.0%) |
| (2) 陽性だが疾患なし(偽陽性) | $P(H_2\|A)$ | $\dfrac{P(A \cap H_2)}{P(A \cap H_1) + P(A \cap H_2)} = \dfrac{P(H_2)P(A\|H_2)}{P(H_1)P(A\|H_1) + P(H_2)P(A\|H_2)} = \dfrac{0.935 \times 0.01}{0.065 \times 0.7 + 0.935 \times 0.01}$ | 0.170 (17.0%) |
| (3) 陰性で疾患なし(真陰性) | $ P(H_2\|A^{c})$ | $\dfrac{P(A^{c} \cap H_2)}{P(A^{c} \cap H_1) + P(A^{c} \cap H_2)} = \dfrac{P(H_2)P(A^{c}\|H_2)}{P(H_1)P(A^{c}\|H_1) + P(H_2)P(A^{c}\|H_2)} = \dfrac{0.935 \times 0.99}{0.065 \times 0.3 + 0.935 \times 0.99} $ | 0.979 (97.9%) |
| (4) 陰性だが疾患あり(偽陰性) | $P(H_1\|A^{c})$ | $\dfrac{P(A^{c} \cap H_1)}{P(A^{c} \cap H_1) + P(A^{c} \cap H_2)} = \dfrac{P(H_1)P(A^{c}\|H_1)}{P(H_1)P(A^{c}\|H_1) + P(H_2)P(A^{c}\|H_2)}= \dfrac{0.065 \times 0.3}{0.065 \times 0.3 + 0.935 \times 0.99} $ | 0.021 (2.1%) |

### 考察（2回目）

陽性の場合

* 検査結果が陽性の場合、真陽性率は83.0%と、1回目よりも大幅に高まっている。
* これは、1回目の検査で陽性となり、疾患の疑いが強まったという状況変化が反映されたためである。
* この真陽性率83.0%を事前確率として、さらに3回目の検査結果を試算すると、真陽性率(3回目・事後)は99.7%とさらに上昇する。

# 付録 - FTA, FMEA, DRBFMと確率

ベイズの定理の意義の一つとして、予め原因と故障の関係を整理することは、故障や不具合自体の低減に役立つことを述べた。<br>
ここでは、故障解析の手法（FTA、FMEA、DRBFM）に確率を付した例を示す。

## 例1：FTAと確率

FTA (Fault Tree Analysis / 故障の木解析) (システム故障 → 部品故障へ分解) に確率を付したもの。<br>
設計や運用の各段階で原因と故障の関係を定量的に論じ、調査し、整理することは、気づきや発見を促し、故障や不良そのものを減らすことに役立つ。<br>
また、製品不良が起こったときに、原因ごとの確率を客観的に示し、調査・対策の優先度をつけることが可能となる。

![FTA](./bayes%20theorem%20and%20disease%20test%20data/FTA.png)

## 例2：FMEAと確率

FMEA (Failure Mode and Effects / 故障モード影響解析) (部品故障 → システム故障への影響解析)

| 機能ブロック | 機能部品 | 機能 | 故障モード | 推定原因 | 頻度 (事前確率 $H_i$) | 故障が製品不良の原因となる条件付き確率 $P(A\|H_i)$ |
| --- | --- | --- | --- | --- | --- | --- |
| 機械 | 軸接手 | 回転力の伝達 | ガタつき | 摩耗 | 0.3 | 0.2 |





## 例3：DRABFMと確率

DRBFM (Design Review Based on Failure Mode) (変更点・変化点に着目した故障モードの影響解析)

# まとめ

* 本稿では、最初に条件付き確率とベイズの定理について理論を確認した。
* 次に応用例として、疾患の検査を想定し、陽性の場合に真に疾患があるかどうかを統計的に調べた。
* また付録として、故障解析の手法（FTA、FMEA、DRBFM）に確率を付した例を示した。
* 条件付き確率やベイズの定理を使うと、可能性を理論的・定量的に検討できる。それは、直感や印象に惑わされることなく、客観的に、適切な対応をとるために役立つものである。

# 参考文献

# 著者

2025/2/22 松山 貴佳  
www.linkedin.com/in/takayoshi-matsuyama-055381a5

