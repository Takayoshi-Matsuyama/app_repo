# ベイズの定理とPCR検査

# 要旨

本稿は、個人的に勉強した内容を技術論文としてまとめたものである。

本稿を書くために使用したpythonコードをフリーウェアとして公開する。

## ベイズの定理

* ある事象（結果）と、その要因となっている複数の事象（原因）を考える<br>
例1：故障（結果）と、部品の不良（原因）<br>
例2：陽性（結果）と、罹患（原因）
* 原因ごとに結果が発生する確率が予め調査済みであるとする。<br>
ベイズの定理を使うと、その結果となったとき、それぞれの原因が実際に結果を引き起こした確率を計算できる

## ベイズの定理の意義

* 故障や不具合が発生したときに、調査・対策に優先順位を付け、早期に解決を図ることができる<br>
* 予め原因と故障の関係を整理することは、設計・開発段階での問題発見を促す。その結果、故障や不具合自体を低減できる。<br>故障の原因や影響の解析方法として、以下が知られている。
    * FTA (Fault Tree Analysis / 故障の木解析) (システム故障 → 部品故障へ分解)
    * FMEA (Failure Mode and Effects / 故障モード影響解析) (部品故障 → システム故障への影響解析)
    * DRBFM (Design Review Based on Failure Mode) (変更点・変化点に着目した故障モードの影響解析)
* 検査の結果を理論的に検討して、直感や印象に惑わされることなく、適切な対応をとることができる

## 本稿の内容

* 理論の確認（ベイズの定理）
* PCR検査への応用。陽性の場合でも、1回の検査だけでは、真に罹患しているかどうかは分からないことを示す。

# 理論の確認

## 条件付き確率
事象 $A$ が起こるという条件の下で事象 $B$ が起こる確率は、それぞれの事象の要素数の比。その分子分母を全事象 $\Omega$ の数で割る。

$$
P(B|A) = \dfrac{N_{A \cap B}}{N_A} = \dfrac{\dfrac{N_{A \cap B}}{N_\Omega}}{\dfrac{N_A}{N_\Omega}} = \frac{P(A \cap B)}{P(A)}
$$

![hist-chi2](./bayes%20theorem%20and%20PCR%20test%20data/A%20and%20B.png)

### 例

サイコロの目が偶数である $(A = \{2, 4, 6 \})$ という条件の下で    
その目が2である $(B = \{ 2 \})$  
この確率は

$$
P(B|A) = \frac{P(A \cap B)}{P(A)} = \dfrac{\frac{1}{6}}{\frac{3}{6}} = \frac{1}{3}
$$

## 乗法定理

条件付き確率の式の両辺に $P(A)$ を掛ける

$$
P(A \cap B) = P(A) P(B|A)
$$

### 例

10本のくじあり、当たり3本  
太郎さんが当たり $(A)$ という条件の下で  
花子さんも当たり $(B|A)$ という事象が  
同時に起こる $(A \cap B)$  
この確率は

$$
P(A \cap B) = P(A) P(B|A) = \frac{3}{10} \times \frac{2}{9} = \frac{1}{15}
$$

## ベイズの定理

事象 $A$ がある  
事象 $A$ の原因として、排反な $n$ 個の事象 $H_1, H_2, \dots, H_n$ がある

![hist-chi2](./bayes%20theorem%20and%20PCR%20test%20data/A%20and%20Hn.png)

事象 $A$ が起こったという条件の下で  
その原因が $H_i$ であったとする  
この条件付き確率は
$$
\begin{aligned}
P(H_i|A) &= \frac{P(H_i \cap A)}{P(A)} \\
         &= \frac{P(H_i) P(A|H_i)}{P(A)} \quad (乗法定理) \\
         &= \frac{P(H_i) P(A|H_i)}{P(A \cap H_1) + P(A \cap H_2) + \cdots + P(A \cap H_n)} \quad (和事象の確率) \\
         &= \frac{P(H_i) P(A|H_i)}{P(H_1)P(A|H_1) + P(H_2)P(A|H_2) + \cdots + P(H_n)P(A|H_n)} \quad (乗法定理) \\
         &= \frac{P(H_i) P(A|H_i)}{\displaystyle \sum_{j=1}^n P(H_j)P(A|H_j)}
\end{aligned}
$$

まとめる。ベイズの定理：
$$
P(H_i|A) = \frac{P(H_i) P(A|H_i)}{\displaystyle \sum_{j=1}^n P(H_j)P(A|H_j)}
$$

$P(H_i)$ は **事前確率 (prior probability)** と呼ばれる (事象 $H_i$ は $A$ に先立つものと考える)  
$P(H_i|A)$ は **事後確率 (posterior probability)** と呼ばれる (事象 $A$ が起こったという条件の下で、 $H_i$が発生)


$P(A|H_i)$ (原因ごとに事象 $A$ が起こる条件付き確率)が推定可能な場合、  
事象 $A$ が起こったとき、それぞれの原因が実際に結果を引き起こした確率 (事後確率 $P(H_i|A)$ ) を計算できる。

# 応用 (PCR検査)

検査する毎に、陰性の人が対象から外れていく
母集団が減る
真陽性の確率が上がる

![test1](./bayes%20theorem%20and%20PCR%20test%20data/test1.png)

事前確率

| 項目 | 式 | 値 | 備考 |
| --- | --- | --- | --- |
| 疾患率 | $P(H_1)$ | 0.001 | 全人口における疾患率<br>=検査対象者(無作為抽出)における疾患率|
| 疾患なし率 | $P(H_2) = 1 - P(H_1)$ | 0.999 | |


検査性能

| 項目 | 式 | 値 |
| --- | --- | --- |
| (1) 真陽性率(感度) | $P(A\|H_1)$ | 0.7 |
| (2) 偽陽性率 | $P(A\|H_2) = 1-P(A^{c}\|H_2)$ | 0.01 |
| (3) 真陰性率(特異度) | $P(A^{c}\|H_2)$ | 0.99 |
| (4) 偽陰性率 | $P(A^{c}\|H_1) = 1 - P(A^{c}\|H_1)$ | 0.3 |

事後確率

| 項目 | 式 | 値 |
| --- | --- | --- |
| 陽性で疾患あり(真陽性) | $P(H_1\|A)$ | --- |
| 陽性だが疾患なし(偽陽性) | $P(H_2\|A)$ | --- |
| 陰性で疾患なし(真陰性) | $P(H_2\|A^{c})$ | --- |
| 陰性だが疾患あり(偽陰性) | $P(H_1\|A^{c})$ | --- |


# 以下、作成中



