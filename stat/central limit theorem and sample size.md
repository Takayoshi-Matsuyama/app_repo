# 中心極限定理とサンプルサイズ

# 要旨

## サンプルサイズ

現場のデータ活用においては適切なサンプルサイズを決定することが重要である。
なぜなら、末端機器のストレージサイズは限られる。また上位システムのストレージにもコストがかかる。
必要最小限のデータのみ蓄積することが望ましく、そのためのサンプルサイズを理論的に決定できれば有益である。

## 機器性能の制約

また、末端の機器は機械学習やAIの実行に必要な計算能力やストレージを持たない。
末端の機器に搭載可能なデータ処理手段があれば、有益である。

## ホワイトボックス

機械学習やAIによる判断の詳細は、アルゴリズム内に隠蔽され人には理解が難しい。
また、確率に基づくあいまいさが含まれ、確実に不良品を識別するための、説明可能な閾値を設定することができない。

## 中心極限定理

中心極限定理によると、確率変数の和（平均）の分布は、サンプル数が増加すると正規分布に近づく。
正規分布に持ち込めば、様々な統計処理が容易となる。
1σ、2σなど、説明可能な閾値を設定したり、サンプルサイズを理論的に計算することも可能である。
また、平均を計算する処理には高い演算性能やストレージは不要であり、末端機器にも搭載可能である。
さらに、末端機器で前処理を済ませれば、上位システム側の負担も軽減できる。

## 本稿の内容

本稿では上記に基づき、次の2項目を確認する。資料としてPythonのサンプルコードを添付する。

1. 中心極限定理の実例
2. 仮説検定に必要なサンプルサイズの計算

# 中心極限定理の実例

## サンプルデータ

中心極限定理を確かめるため、正規分布以外のデータを使う。ここでは、例としてカイ二乗分布を使う。

データ(1) 自由度5のカイ二乗分布から100サンプル取得し、平均値を計算する。

![hist-chi2](./central%20limit%20theorem%20and%20sample%20size%20data/hist-chi2.png)

データ(2) 上記の平均値の計算を30000回繰り返す。平均値のヒストグラムの例を示す。

![hist-chi2-mean](./central%20limit%20theorem%20and%20sample%20size%20data/hist-chi2-mean.png)

## 正規性の検討

中心極限定理によれば、サンプルサイズが増えるに従い、平均値の分布は正規分布に近づく。

データ(2)の歪度と頻度を計算すると

歪度 = 0.12

尖度 = 0.05

いずれも0に近く、正規分布と見てよいと判断する。

加えて、Q-Qプロットを確認する。

![Q-Q plot](./central%20limit%20theorem%20and%20sample%20size%20data/Q-Q%20plot.png)

ほぼ直線であり、この点においても、データ(2)の分布は正規分布と見てよい。

以上、中心極限定理の実例を確認した。

# 仮説検定に必要なサンプルサイズの計算

サンプルデータが不足すれば、統計的に妥当な判定をすることはできない。
また、サンプルデータが多すぎると、ストレージを無駄に使ってしまう。
ここでは、母平均の仮説検定を例に、必要十分なサンプルサイズを計算する。

## 仮説検定 (母平均)

母平均 $\mu$ が $\mu_0$ と異なるかどうかを検証する有意水準2.5%の片側検定を考える。

帰無仮説H0: $\mu = \mu_0$  
対立仮説H1: $\mu = \mu_1 (> \mu_0)$

### 帰無仮説H0の下で

統計量 $Z_0 = \dfrac{\overline{X} - \mu_0}{\sqrt{\sigma^2/n}}$ は標準正規分布 $N(0, 1)$ に従う。

片側有意水準2.5%（誤ってH0棄却。異常見すぎ）の棄却限界値 $z_{\alpha/2} = z_{0.025}$ = 1.96

### 対立仮説H1の下で

統計量 $Z_1 = \frac{\overline{X} - \mu_0}{\sqrt{\sigma^2/n}}$ は正規分布 $N(\mu_1 - \mu_0, 1)$ に従う。

第二種の過誤（誤ってH0受容。異常見逃し）の確率 $\beta$ =0.2（検出力0.8）に相当する正規分位点 $z_{\beta} = z_{0.2}$ = 0.84


### サンプルサイズnを求める方程式

H0の棄却限界値 = H1の正規分位点

$\mu_0 + z_{\alpha/2} \sqrt{\dfrac{\sigma^2}{n}} = \mu_1 - z_{\beta} \sqrt{\dfrac{\sigma^2}{n}}$

$(z_{\alpha/2}+z_{\beta})\sqrt{\sigma^2} = (\mu_1 - \mu_0) \sqrt{n}$

$n = \dfrac{(z_{\alpha/2}+z_{\beta})^2 \sigma^2}{(\mu_1 - \mu_0)^2}$

### 計算例

母平均 $\mu$ が $\mu_0$ と異なるかどうかを検証する有意水準2.5%の片側検定を考える。

帰無仮説H0: $\mu = \mu_0 = 5$  
対立仮説H1: $\mu = \mu_1 = 5.5(> \mu_0)$

標準偏差 $\sigma = 2$

検定の第二種の過誤（誤ってH0受容。異常見逃し）の確率 $\beta$ =0.2（検出力0.8）に必要なサンプルサイズ $n$

$n = \dfrac{(z_{\alpha/2}+z_{\beta})^2 \sigma^2}{(\mu_1 - \mu_0)^2} = \dfrac{(1.96 + 0.84)^2 \times 2^2}{(5.5 - 5)^2} = 125.4 = 126$

このときの $\overline{X}$ の確率分布と棄却限界値を以下に示す。
棄却限界値のラインにおいて、第一種の過誤の確率（片側） $\alpha/2$ と第二種の過誤の確率 $\beta$ が釣り合っていることがわかる。

![平均値の分布](./central%20limit%20theorem%20and%20sample%20size%20data/mean_prob_dist_01.png)


## 仮説検定 (母平均の差)

2つの正規分布の母平均( $\mu_1$ , $\mu_2$ )に差があるかどうかを検証する有意水準2.5%の片側検定を考える。

### 正規分布1
確率変数 $X_1$  
標本平均 $m_1$, 母平均 $\mu_1$    
標本分散 $s_1^2$, 母分散 $\sigma_1^2$  
サンプルサイズ $n_1$

### 正規分布2
確率変数 $X_2$  
標本平均 $m_2$, 母平均 $\mu_2$    
標本分散 $s_2^2$, 母分散 $\sigma_2^2$  
サンプルサイズ $n_2$

### 検定
標本平均の差 $d=m_1-m_2$ も正規分布に従うことを利用する。  
$d$ の母集団値 $\delta = E[d] = \mu_1 - \mu_2$  
帰無仮説 H0: 前後の平均値に差がない ( $\delta = d_0 (= 0)$ )  
対立仮設 H1: 前後の平均値に差がある ( $\delta = d_1 (> 0)$ )

### 帰無仮説H0の下で

$d \sim N(0, \dfrac{\sigma_1^2}{n_1} + \dfrac{\sigma_2^2}{n_2})$

片側有意水準2.5%（誤ってH0棄却。異常見すぎ）の棄却限界値 = 1.96

### 対立仮説H1の下で

$d \sim N(d_1, \dfrac{\sigma_1^2}{n_1} + \dfrac{\sigma_2^2}{n_2})$

第二種の過誤（誤ってH0受容。異常見逃し）の確率 $\beta$ =0.2（検出力0.8）に相当する正規分位点 = 0.84

### サンプルサイズnを求める方程式

H0の棄却限界値 = H1の正規分位点

$\mu_0 + z_{\alpha/2} \sqrt{\dfrac{\sigma_1^2}{n_1} + \dfrac{\sigma_2^2}{n_2}} = \mu_1 - z_{\beta} \sqrt{\dfrac{\sigma_1^2}{n_1} + \dfrac{\sigma_2^2}{n_2}}$

簡単のため、 $n = n_1 = n_2$ とすると

$\mu_0 + z_{\alpha/2} \sqrt{\dfrac{\sigma_1^2 + \sigma_2^2}{n}} = \mu_1 - z_{\beta} \sqrt{\dfrac{\sigma_1^2 + \sigma_2^2}{n}}$

$(z_{\alpha/2}+z_{\beta})\sqrt{\sigma_1^2 + \sigma_2^2} = (\mu_1 - \mu_0) \sqrt{n}$

$n = \dfrac{(z_{\alpha/2}+z_{\beta})^2 (\sigma_1^2 + \sigma_2^2)}{(\mu_1 - \mu_0)^2}$

# 以降、作成中

# 参考文献
